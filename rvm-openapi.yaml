openapi: 3.0.3
x-stoplight:
  id: ec6717f423206
tags:
  - name: machine
    description: Api part strictly related to RVM machines
  - name: product
    description: API part related with Product interaction between Kaucja and RVM providers
  - name: transaction
    description: API part related with Transaction interaction between Kaucja and RVM providers
  - name: user
    description: Part of an api related with user authentication
info:
  title: RVM API Representation
  description: |
    API description for RVM (Reverse Vending Machine).
    RVM providers should expose presented endpoints in order to be able to communicate with DRS
    that Kaucja.pl is exposing 
  contact:
    name: Dawid Brylka
    url: 'https://www.kaucja.pl'
    email: dawid.brylka@kaucja.pl
  license:
    name: Apache 2.0
    url: 'http://www.apache.org/licenses/LICENSE-2.0.html'
  version: 1.0.11
paths:
  /machine:
    post:
      tags:
        - machine
      summary: Add new RVM
      description: |
        Endpoint called by DRS provider in order to register new RVM in provider system.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostMachine'
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: 35nqny8k7q39d
    get:
      tags:
        - machine
      summary: Get All Machine data
      description: Get Machine data
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  pageNo:
                    type: integer
                  pageSize:
                    type: integer
                  totalItemCount:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Machine'
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: vlhfuryxrsykg
  '/machine/{id}/unblock':
    put:
      tags:
        - machine
      summary: Unblock RVM to working state
      description: Unblock RVM to working state
      parameters:
        - name: id
          in: path
          description: ID/SN of a Machine
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: qodfbkmaqt7j5
  '/machine/{id}':
    delete:
      tags:
        - machine
      summary: Delete RVM
      description: Delete RVM
      parameters:
        - name: id
          in: path
          description: ID/SN of a Machine
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: yqbj8ha1c5o2p
    get:
      tags:
        - machine
      summary: Get Machine data
      description: Get Machine data
      parameters:
        - name: id
          in: path
          description: 'The name that needs to be fetched. Use user1 for testing. '
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Machine'
            application/xml:
              schema:
                $ref: '#/components/schemas/Machine'
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: 7cizixnah104k
  /transaction:
    get:
      tags:
        - transaction
      parameters:
        - name: rvmId
          in: query
          description: Transactions from particular RVM
          required: false
          schema:
            type: string
        - name: delivered
          in: query
          description: Transactions from particular RVM
          schema:
            type: boolean
        - name: from
          in: query
          description: Transactions from particular Date
          required: false
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: Transactions to particular Date
          required: false
          schema:
            type: string
            format: date-time
        - name: transactionCount
          in: query
          description: Max number of transactions
          required: false
          schema:
            type: integer
        - $ref: '#/components/parameters/Startindex'
        - $ref: '#/components/parameters/Pagelength'
      summary: Get All Transactions
      description: Get All Transactions
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: object
                properties:
                  pageNo:
                    type: integer
                  pageSize:
                    type: integer
                  totalItemCount:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: models/Transaction.yaml
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: 9jlaedwrqzo5n
  '/transaction/{id}':
    get:
      tags:
        - transaction
      parameters:
        - name: id
          in: path
          description: ID of a Transaction
          required: true
          schema:
            type: string
      summary: Get Transaction
      description: Get Transaction
      responses:
        '200':
          description: Successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: models/Transaction.yaml
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: jyyegnihghexq
  '/transaction/{id}/confirmation':
    put:
      tags:
        - transaction
      parameters:
        - name: id
          in: path
          description: ID of a Transaction
          required: true
          schema:
            type: string
      summary: Get Transaction
      description: Get Transaction
      responses:
        '200':
          description: Successful operation
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: sw1i2ci6d2hgr
  /product:
    post:
      tags:
        - product
      summary: Add or update product
      description: |
        Endpoint called by DRS in order to add/update product that has been changed in DRS side.  
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: models/Product.yaml
      responses:
        '200':
          description: Successful operation
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: rxi2pcz3px8sq
  /product/bulk:
    post:
      tags:
        - product
      summary: Add or update product
      description: |
        Endpoint called by DRS in order to add/update product that has been changed in DRS side.  
        Difference is that this endpoint should take x objects instead on single one
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: models/Product.yaml
      responses:
        '200':
          description: Successful operation
        '400':
          description: Invalid input
        '422':
          description: Validation exception
      x-stoplight:
        id: e3nk1pim9ekam
security:
  - bearerAuth: []
components:
  securitySchemes:
    bearerAuth: # arbitrary name for the security scheme
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    Pagelength:
      name: pagelength
      in: query
      description: Number of records to return
      schema:
        type: number
    Startindex:
      name: startindex
      in: query
      description: Start index for paging
      schema:
        type: number
  schemas:
    PostMachine:
      type: object
      required:
        - serialNumber
        - location
        - bins
      properties:
        serialNumber:
          type: string
          format: uuid
          description: Serial number of machine
          x-stoplight:
            id: 8pp4kxobuhvlh
        name:
          type: string
          description: RVM Customer/provider given name.
        location:
          $ref: '#/components/schemas/Location'
        bins:
          type: array
          items:
            $ref: '#/components/schemas/BinPost'
      x-internal: false
      x-stoplight:
        id: fvntp98cbkrsr
    Machine:
      type: object
      allOf:
      - $ref: "#/components/schemas/PostMachine"
      - properties:
          id:
            type: string
            format: uuid
          health:
            $ref: '#/components/schemas/Health'
          bins:
            type: array
            items:
              $ref: '#/components/schemas/Bin'
          ean_sync_date:
            type: string
            format: date-time
          lastTransaction:
            type: string
            format: date-time
      x-stoplight:
        id: 8g021fi6n2gxd
    Health:
      type: object
      properties:
        statusCode:
          $ref: '#/components/schemas/RvmHealthStatusCodeEnum'
        powerStatus:
          $ref: '#/components/schemas/PowerStatusEnum'
        lastContactDate:
          type: string
          format: date-time
          description: When RVM Cloud has last contact with RVM
        lastCleaningDate:
          type: string
          format: date-time
      x-stoplight:
        id: sj89q9h8uo3dh
    BinPost:
      type: object
      properties:
        wasteType:
          type: array
          items:
            $ref: models/enum/WasteTypeEnum.yaml
        litrage:
          type: integer
          example: 240
          description: Capacity of bag in liters
      x-stoplight:
        id: nthgfqrhpl4tl
    Bin:
      allOf:
        - $ref: '#/components/schemas/BinPost'
        - type: object
          properties:
            isFull:
              type: boolean
            lastEmptied:
              type: string
              example: '2021-02-12T11:21:33Z'
            lastFull:
              type: string
              example: '2021-02-11T11:21:33Z'
            fillLevel:
              type: number
              example: 0.3
              description: |
                Fullness level of the bag. where 0 means 0%, 1 means 100%
            currentWeight:
              type: number
              example: 10.12
            containers:
              type: integer
              example: 123
              description: How many containers is in bag
      x-stoplight:
        id: r7i834ho3kwqk
    Location:
      type: object
      required:
        - city
        - zipcode
        - country
        - address
      properties:
        city:
          type: string
          example: Szczecin
        zipcode:
          type: string
          format: zipcode
          example: 11-111
        country:
          type: string
          format: country
          example: Polska
        address:
          type: string
          format: address
          example: Dąbrowska 20
        longitude:
          type: number
          example: 51.11
        latitude:
          type: number
          example: 52.22
      x-stoplight:
        id: k1p0x39errlzd
    RvmHealthStatusCodeEnum:
      title: RvmHealthStatusCodeEnum
      x-stoplight:
        id: rc4y3ej0bksk2
      type: integer
      enum:
        - 0
        - 1
        - 2
      description: |
        Descriptor for RVM Health Status <br>
        Where
        * 0 - RVM status is operational
        * 1 - RVM is full
        * 2 - RVM Out of Service
        * 3 - Lost Contact
    PowerStatusEnum:
      title: PowerStatusEnum
      x-stoplight:
        id: tvswmeaefue84
      type: integer
      enum:
        - 0
        - 1
      description: |
        Descriptior for RVM Power Status <br>
        Where: <br>
        * 0 - Powered Off
        * 1 - Powered On
    apiKey:
      type: apiKey
      name: api_key
      in: header
